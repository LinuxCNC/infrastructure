
<html>

<head>
<title>
LinuxCNC Buildbot: Buildslave Admin's Guide
</title>
</head


<body>

<center>
<h2>
LinuxCNC Buildbot: Buildslave Admin's Guide
</h2>
</center>

<p>This document describes how to set up a <a
href="http://buildbot.net">Buildbot</a> buildslave for LinuxCNC.

<p>Running a buildslave requires only a computer that
can check out and compile the linuxcnc git repo, can run
<a href="http://twistedmatrix.com/trac/">twisted</a> <a
href="http://www.python.org/">python</a>, and can make outgoing TCP
connections to the <a href="http://buildbot.linuxcnc.org">buildmaster
computer</a>.

<hr>

<ol>

    <li>

        <p>Disable the screensaver or set it to only blank the screen
        (so as not to soak up CPU cycles with useless fancy eye candy).

    </li>


    <li>

        <p>Make a user to run the buildslave.  It is not a good idea to
        run the buildslave as yourself.  I'll refer to the user as just
        "the buildslave user" in this document.  You can name the user
        anything you want.  Give this user a sneaky password that only
        you know.

    </li>


    <li>

        <p>Install the following packages:

        <ul>

            <li>'ntp' (so the time will be right)

            <li>'lsb-release' (so the buildslave can describe itself)

            <li>'fakeroot' (so the buildslave can build the debian package)

            <li>'build-essential' (because it's essential for building)

            <li>'tree' (used by some build steps to show what's going on)

            <li>'pbuilder' (used to install build dependencies)

        </ul>

        <p><tt>apt-get install ntp lsb-release fakeroot build-essential tree pbuilder</tt>

    </li>


    <li>

        <p>Do an anonymous Git checkout as the buildslave user (in a
        throw-away directory out of the way) to make sure sure you can,
        and to make sure you have the ssh hostkey of the Git server
        machine.

        <p><tt>git clone git://git.linuxcnc.org/git/linuxcnc.git linuxcnc-dev</tt>

    </li>


    <li>

        <p>The buildbot checks for missing build dependencies and
        automatically installs them on the buildslave computer
        each time it builds.  In order for this to work, you
        must give your buildslave user the ability to run "sudo
        /usr/lib/pbuilder/pbuilder-satisfydepends" without a password.

        <p>Add this line to /etc/sudoers:

        <p><tt>buildslave-user ALL = ALL, NOPASSWD: /usr/lib/pbuilder/pbuilder-satisfydepends</tt>

    </li>


    <li>

        <p>At least on Hardy and Lucid, apt automatically updates
        the package list using a daily cronjob, /etc/cron.daily/apt.
        The buildbot also tries to update the package lists when it
        builds, and this can lead to conflict and spurious build failures.
        Thus you should disable automatic updating of the package lists,
        and let the buildbot handle it.

        <p>The cronjob is configured by a bunch of APT::Periodic
        apt-conf variables.  A reasonable way to set these
        variables is to install the update-notifier-common
        package, then change /etc/apt/apt.conf.d/10periodic so
        APT::Periodic::Update-Package-Lists is "0".

    </li>


    <li>

        <p>Install a recent version of buildbot.  0.7.10 is the oldest
        version known to work.  Versions before 0.7.10 don't work well
        with Git.

        <p>The buildbot package in Ubuntu Lucid is new enough that it
        Just Works:

        <p><tt>apt-get install buildbot</tt>

        <p>Ubuntu Hardy has buildbot 0.7.6, which is too
        old.  If your buildslave is Hardy or older, you
        need to install buildbot from somewhere other than
        the default Ubuntu repository.  I've had success with <a
        href="https://launchpad.net/~mwhudson/+archive/ppa?field.series_filter=hardy">Michael
        Hudson-Doyle's PPA</a>

    </li>


    <li>

        <p>Now we're ready to set up the buildslave itself.  You will
        need two pieces of information from the buildmaster admin:
        the slave name and the slave password.  Ask for this on the
        emc-devel mailing list.

        <p>The slave name is just a unique identifier for your buildslave.
        It should ideally be descriptive of the environment that you're
        building on, for example "hardy-rtai-x86".

        <p>The slave password is totally unrelated to the Unix login
        password of the buildslave user.

        <p><tt>mkdir ~/BuildBot/slave/$SLAVE_NAME</tt>

        <p><tt>buildbot create-slave ~/BuildBot/slave/$SLAVE_NAME buildbot.linuxcnc.org:51332 $SLAVE_NAME $SLAVE_PASSWORD</tt>

        <p>(The buildslave directory above is just a suggestion, you can put it anywhere you like.)

        <p>If you're using buildbot` version 0.7.9 or older, you need
        to edit buildbot.tac to set "usepty = 0".  0.7.10 and newer do
        not need this change.

    </li>


    <li>

        <p>On Ubuntu releases from Dapper through Lucid, the
        buildbot package provides an init script that starts the
        buildslave automatically on system boot.  This script sources
        /etc/default/buildbot, so you need to fill it out with the
        particulars of your setup.

        <p>On other distros, buildbot may be started differently.

    </li>


    <li>

        <p>Edit the <tt>info/admin</tt> and <tt>info/host</tt> files in
        your buildslave directory (<tt>~/BuildBot/slave/$SLAVE_NAME</tt>
        in the example above).  <tt>admin</tt> should have
        your name and email address, and <tt>host</tt>
        should have a brief description of your host.
        For some examples (minus the email addresses), see the <a
        href="http://buildbot.linuxcnc.org/buildbot/buildslaves">BuildSlave</a>
        page.

    </li>


    <li>

        <p><b>This step is optional!</b>

        <p>If you want your buildslave to run the real-time test suite, you need to do two more things:

        <ol>

            <li>

                <p>You must let the buildslave user run a couple of
                sudo commands without passwords.  The first is "sudo
                /usr/bin/make V=1 setuid" which enables the setuid bit on a
                couple of helper programs, without this the tests wont be
                able to load kernel modules.  The second sudo command is
                "sudo /bin/dmesg -c" which clears the dmesg log, this is
                done before running the tests so that the dmesg reported
                after the tests finish contains just the info for this
                test run.

                <p>Add this line to /etc/sudoers:

                <p><tt>buildslave-user ALL = ALL, NOPASSWD: /usr/bin/make V=1 setuid , /bin/dmesg -c</tt>

            </li>


            <li>

                <p>You need to allow the buildslave user to lock
                more memory than the default configuration allows.
                If you're starting buildbot from the init scripts at
                system boot, the easiest way to do this is to add this
                line to /etc/default/buildbot:

                <p><tt>ulimit -l unlimited</tt>

            </li>

        </ol>

    </li>


    <li>

        <p><b>This step is optional!</b>

        <p>If you want your buildslave to build debs, you need to set up
        a pbuilder chroot:

        <ol>

            <li>

                <p>Create the pbuilder chroot:

                <p><tt>sudo pbuilder --create --basetgz
                $HOME/pbuilder-$DIST-emc2.tgz --distribution
                $DIST --components 'main universe' --othermirror
                "$LINUXCNC_ARCHIVE|deb http://us.archive.ubuntu.com/ubuntu
                $DIST-updates main universe"</tt>

                <p>LINUXCNC_ARCHIVE is the LinuxCNC debian package archive
                for your $DIST.  For example, for Lucid this is "<tt>deb
                http://www.linuxcnc.org lucid base</tt>" and for Hardy
                it's "<tt>deb http://www.linuxcnc.org hardy base</tt>"

                <p>The pbuilder chroot tarball needs to be located in
                the buildslave's home directory, and needs to have the
                name specified above.

            <li>

                <p>Give the buildslave user password-less sudo by adding
                the following line to /etc/sudoers:

                <p><tt>buildslave ALL = ALL, NOPASSWD: /usr/bin/apt-get,
                /usr/sbin/pbuilder, /bin/umount</tt>

            <li>

                <p>Add the buildmaster's source repo to
                /etc/apt/sources.list.d/linuxcnc-buildbot.list.
                The exact form you use here depends on what
                distribution you're building for, look at the <a
                href="http://buildbot.linuxcnc.org">buildbot front
                page</a> for specifics.  For Lucid realtime you'd
                use this:

                <pre>
deb     http://buildbot.linuxcnc.org/ lucid master-rt
deb-src http://buildbot.linuxcnc.org/ lucid master-rt
deb     http://buildbot.linuxcnc.org/ lucid v2.5_branch-rt
deb-src http://buildbot.linuxcnc.org/ lucid v2.5_branch-rt
</pre>

        </ol>

    </li>

</ol>


<hr>

<p>That's it!  I can't believe it was so easy!</p>


</body>
</html>
